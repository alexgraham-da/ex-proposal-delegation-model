module Tests where

import DA.Optional

import Daml.Script

import Templates
import Setup

type ContractPair a = (ContractId a, a)

data TestContracts = TestContracts with
  cA         : ContractPair Company
  caInternal : ContractPair CompanyInternal
  cB         : ContractPair Company
  cbInternal : ContractPair CompanyInternal
    deriving (Show,Eq)

findOrCreate : (Template t, TemplateKey t k) => Party -> t -> Script (ContractId t, t)
findOrCreate party contract = do
  opt <- queryContractKey party (key contract)
  case opt of
    (Some c) -> return c
    None     -> (,) <$> submit party (createCmd contract) <*> return contract

reinitialize : LedgerParties -> Script TestContracts
reinitialize (LedgerParties public companyA companyB a1 a2 b1 b2) = do
  cA         <- findOrCreate companyA $ Company with owner = companyA, name = "Company A", observers = [public]
  caInternal <- findOrCreate companyA $ CompanyInternal with company = snd cA, employees = [a1, a2], management = [a1]
  cB         <- findOrCreate companyB $ Company with owner = companyB, name = "Company B", observers = [public]
  cbInternal <- findOrCreate companyB $ CompanyInternal with company = snd cB, employees = [a1, a2], management = [b1]

  return $ TestContracts cA caInternal cB cbInternal

initializeTests : LedgerParties -> Script TestSetupResults
initializeTests lp@(LedgerParties public companyA companyB a1 a2 b1 b2) = do
  tc@(TestContracts (caId, cA) (caInternalId, caInternal) (cbId, cB) (cbInternalId, cbInternal)) <- reinitialize lp

  proposalId <- b1 `submit` exerciseCmd cbInternalId CompanyInternal_MakeProposal with
        employee = b1, proposedTo = companyA
        proposalText = "B1 proposing to Company A"

  return (lp,proposalId)

type TestSetupResults = (LedgerParties,ContractId Proposal)

testStepTwo : (LedgerParties,ContractId Proposal) -> Script ()
testStepTwo (lp@(LedgerParties public companyA companyB a1 a2 b1 b2), proposalId) = do
  (TestContracts (caId, cA) (caInternalId, caInternal) (cbId, cB) (cbInternalId, cbInternal)) <- reinitialize lp

  proposal <- fromSome <$> queryContractId companyA proposalId

  someDelegatedProposal : Optional (ContractId DelegatedProposal, DelegatedProposal) <- queryContractKey a1 $ key $ DelegatedProposal with proposal, internal = caInternal, employee = a1
  assertMsg "delegated proposal not found" $ isSome someDelegatedProposal

  return ()

